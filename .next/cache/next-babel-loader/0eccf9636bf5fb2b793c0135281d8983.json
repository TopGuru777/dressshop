{"ast":null,"code":"import connectDB from '../../utils/connectDB';\nimport Product from '../../models/Product';\nimport Cart from '../../models/Cart';\nexport default (async (req, res) => {\n  await connectDB();\n\n  switch (req.method) {\n    case 'GET':\n      await handleGetRequest(req, res);\n      break;\n\n    case 'DELETE':\n      await handleDelete(req, res);\n      break;\n\n    default:\n      res.status(405).send('Method not allowed');\n      break;\n  }\n});\n\nasync function handleGetRequest(req, res) {\n  const {\n    id\n  } = req.query;\n\n  try {\n    const product = await Product.findOne({\n      _id: id\n    });\n    const {\n      category\n    } = product; // find related products based on category\n\n    const relatedProducts = await Product.find({\n      category,\n      _id: {\n        $ne: id\n      }\n    }).limit(8);\n    res.status(200).json({\n      product,\n      relatedProducts\n    });\n  } catch (error) {\n    console.error(error);\n    res.status(400).send('Product not exist');\n  }\n}\n\nasync function handleDelete(req, res) {\n  const {\n    id\n  } = req.query;\n\n  try {\n    // remove product from db\n    await Product.findOneAndDelete({\n      _id: id\n    }); // remove product from all carts\n\n    await Cart.updateMany({\n      'carts.product': id\n    }, {\n      $pull: {\n        carts: {\n          product: id\n        }\n      }\n    });\n    res.json({\n      success: true,\n      message: 'Successfully delete '\n    });\n  } catch (error) {\n    console.log(error);\n  }\n}","map":{"version":3,"sources":["/home/russ/projects/dress-shop/pages/api/product.js"],"names":["connectDB","Product","Cart","req","res","method","handleGetRequest","handleDelete","status","send","id","query","product","findOne","_id","category","relatedProducts","find","$ne","limit","json","error","console","findOneAndDelete","updateMany","$pull","carts","success","message","log"],"mappings":"AAAA,OAAOA,SAAP,MAAsB,uBAAtB;AACA,OAAOC,OAAP,MAAoB,sBAApB;AACA,OAAOC,IAAP,MAAiB,mBAAjB;AAEA,gBAAe,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACjC,QAAMJ,SAAS,EAAf;;AACA,UAAQG,GAAG,CAACE,MAAZ;AACE,SAAK,KAAL;AACE,YAAMC,gBAAgB,CAACH,GAAD,EAAMC,GAAN,CAAtB;AACA;;AACF,SAAK,QAAL;AACE,YAAMG,YAAY,CAACJ,GAAD,EAAMC,GAAN,CAAlB;AACA;;AACF;AACEA,MAAAA,GAAG,CAACI,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,oBAArB;AACA;AATJ;AAWD,CAbD;;AAeA,eAAeH,gBAAf,CAAgCH,GAAhC,EAAqCC,GAArC,EAA0C;AACxC,QAAM;AAAEM,IAAAA;AAAF,MAASP,GAAG,CAACQ,KAAnB;;AACA,MAAI;AACF,UAAMC,OAAO,GAAG,MAAMX,OAAO,CAACY,OAAR,CAAgB;AAAEC,MAAAA,GAAG,EAAEJ;AAAP,KAAhB,CAAtB;AACA,UAAM;AAAEK,MAAAA;AAAF,QAAeH,OAArB,CAFE,CAGF;;AACA,UAAMI,eAAe,GAAG,MAAMf,OAAO,CAACgB,IAAR,CAAa;AACzCF,MAAAA,QADyC;AAEzCD,MAAAA,GAAG,EAAE;AAAEI,QAAAA,GAAG,EAAER;AAAP;AAFoC,KAAb,EAG3BS,KAH2B,CAGrB,CAHqB,CAA9B;AAIAf,IAAAA,GAAG,CAACI,MAAJ,CAAW,GAAX,EAAgBY,IAAhB,CAAqB;AAAER,MAAAA,OAAF;AAAWI,MAAAA;AAAX,KAArB;AACD,GATD,CASE,OAAOK,KAAP,EAAc;AACdC,IAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACAjB,IAAAA,GAAG,CAACI,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,mBAArB;AACD;AACF;;AAED,eAAeF,YAAf,CAA4BJ,GAA5B,EAAiCC,GAAjC,EAAsC;AACpC,QAAM;AAAEM,IAAAA;AAAF,MAASP,GAAG,CAACQ,KAAnB;;AACA,MAAI;AACF;AACA,UAAMV,OAAO,CAACsB,gBAAR,CAAyB;AAAET,MAAAA,GAAG,EAAEJ;AAAP,KAAzB,CAAN,CAFE,CAGF;;AACA,UAAMR,IAAI,CAACsB,UAAL,CACJ;AAAE,uBAAiBd;AAAnB,KADI,EAEJ;AAAEe,MAAAA,KAAK,EAAE;AAAEC,QAAAA,KAAK,EAAE;AAAEd,UAAAA,OAAO,EAAEF;AAAX;AAAT;AAAT,KAFI,CAAN;AAIAN,IAAAA,GAAG,CAACgB,IAAJ,CAAS;AAAEO,MAAAA,OAAO,EAAE,IAAX;AAAiBC,MAAAA,OAAO,EAAE;AAA1B,KAAT;AACD,GATD,CASE,OAAOP,KAAP,EAAc;AACdC,IAAAA,OAAO,CAACO,GAAR,CAAYR,KAAZ;AACD;AACF","sourcesContent":["import connectDB from '../../utils/connectDB';\nimport Product from '../../models/Product';\nimport Cart from '../../models/Cart';\n\nexport default async (req, res) => {\n  await connectDB();\n  switch (req.method) {\n    case 'GET':\n      await handleGetRequest(req, res);\n      break;\n    case 'DELETE':\n      await handleDelete(req, res);\n      break;\n    default:\n      res.status(405).send('Method not allowed');\n      break;\n  }\n};\n\nasync function handleGetRequest(req, res) {\n  const { id } = req.query;\n  try {\n    const product = await Product.findOne({ _id: id });\n    const { category } = product;\n    // find related products based on category\n    const relatedProducts = await Product.find({\n      category,\n      _id: { $ne: id }\n    }).limit(8);\n    res.status(200).json({ product, relatedProducts });\n  } catch (error) {\n    console.error(error);\n    res.status(400).send('Product not exist');\n  }\n}\n\nasync function handleDelete(req, res) {\n  const { id } = req.query;\n  try {\n    // remove product from db\n    await Product.findOneAndDelete({ _id: id });\n    // remove product from all carts\n    await Cart.updateMany(\n      { 'carts.product': id },\n      { $pull: { carts: { product: id } } }\n    );\n    res.json({ success: true, message: 'Successfully delete ' });\n  } catch (error) {\n    console.log(error);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}