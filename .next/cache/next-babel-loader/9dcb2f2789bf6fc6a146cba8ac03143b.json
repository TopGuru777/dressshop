{"ast":null,"code":"import _Object$defineProperty from \"@babel/runtime-corejs2/core-js/object/define-property\";\nimport _Object$defineProperties from \"@babel/runtime-corejs2/core-js/object/define-properties\";\nimport _Object$getOwnPropertyDescriptors from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptors\";\nimport _Object$getOwnPropertyDescriptor from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptor\";\nimport _Object$getOwnPropertySymbols from \"@babel/runtime-corejs2/core-js/object/get-own-property-symbols\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _extends from \"@babel/runtime-corejs2/helpers/esm/extends\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nvar _jsxFileName = \"/home/russ/projects/dress-shop/pages/_app.js\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = _Object$keys(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React from 'react';\nimport App from 'next/app';\nimport { AuthProvider, ModalProvider, CartProvider } from '../store';\nimport { parseCookies, destroyCookie } from 'nookies';\nimport axios from 'axios';\nimport baseURL from '../utils/baseURL';\nimport { redirectUser } from '../utils/auth';\n\nclass MyApp extends App {\n  constructor(...args) {\n    super(...args);\n\n    _defineProperty(this, \"synLogout\", event => {\n      if (event.key === 'logout') {\n        window.location.href = '/login';\n      }\n    });\n  }\n\n  static async getInitialProps({\n    Component,\n    ctx\n  }) {\n    const {\n      token\n    } = parseCookies(ctx);\n    let pageProps = {},\n        currentUser = null;\n\n    if (Component.getInitialProps) {\n      pageProps = await Component.getInitialProps(ctx);\n    }\n\n    if (token) {\n      try {\n        // verify token if its valid\n        const payload = {\n          headers: {\n            authorization: token\n          }\n        };\n        const response = await axios.get(`${baseURL}/api/account`, payload);\n        const user = response.data;\n        const isAdmin = user.role === 'admin';\n        const isNotPermitted = !isAdmin && ctx.pathname === '/admin';\n\n        if (isNotPermitted) {\n          redirectUser(ctx, '/');\n        }\n\n        currentUser = user;\n      } catch (error) {\n        destroyCookie(ctx, 'token');\n        redirectUser(ctx, '/login');\n      }\n    } else {\n      const isProtectedRoute = ctx.pathname === '/account' || ctx.pathname === '/admin';\n      if (isProtectedRoute) redirectUser(ctx, '/login');\n    }\n\n    return _objectSpread({}, pageProps, {\n      currentUser\n    });\n  }\n\n  componentDidMount() {\n    window.addEventListener('storage', this.synLogout);\n  } //refresh page when logout\n\n\n  render() {\n    const {\n      Component,\n      pageProps,\n      currentUser\n    } = this.props;\n    return __jsx(AuthProvider, {\n      currentUser: currentUser,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 60\n      },\n      __self: this\n    }, __jsx(CartProvider, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 61\n      },\n      __self: this\n    }, __jsx(ModalProvider, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 62\n      },\n      __self: this\n    }, __jsx(Component, _extends({}, pageProps, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 63\n      },\n      __self: this\n    })))));\n  }\n\n}\n\nexport default MyApp;","map":{"version":3,"sources":["/home/russ/projects/dress-shop/pages/_app.js"],"names":["React","App","AuthProvider","ModalProvider","CartProvider","parseCookies","destroyCookie","axios","baseURL","redirectUser","MyApp","event","key","window","location","href","getInitialProps","Component","ctx","token","pageProps","currentUser","payload","headers","authorization","response","get","user","data","isAdmin","role","isNotPermitted","pathname","error","isProtectedRoute","componentDidMount","addEventListener","synLogout","render","props"],"mappings":"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","sourcesContent":["import React from 'react';\nimport App from 'next/app';\nimport { AuthProvider, ModalProvider, CartProvider } from '../store';\nimport { parseCookies, destroyCookie } from 'nookies';\nimport axios from 'axios';\nimport baseURL from '../utils/baseURL';\nimport { redirectUser } from '../utils/auth';\n\nclass MyApp extends App {\n  static async getInitialProps({ Component, ctx }) {\n    const { token } = parseCookies(ctx);\n\n    let pageProps = {},\n      currentUser = null;\n\n    if (Component.getInitialProps) {\n      pageProps = await Component.getInitialProps(ctx);\n    }\n\n    if (token) {\n      try {\n        // verify token if its valid\n        const payload = { headers: { authorization: token } };\n        const response = await axios.get(`${baseURL}/api/account`, payload);\n        const user = response.data;\n        const isAdmin = user.role === 'admin';\n        const isNotPermitted = !isAdmin && ctx.pathname === '/admin';\n        if (isNotPermitted) {\n          redirectUser(ctx, '/');\n        }\n        currentUser = user;\n      } catch (error) {\n        destroyCookie(ctx, 'token');\n        redirectUser(ctx, '/login');\n      }\n    } else {\n      const isProtectedRoute =\n        ctx.pathname === '/account' || ctx.pathname === '/admin';\n      if (isProtectedRoute) redirectUser(ctx, '/login');\n    }\n\n    return { ...pageProps, currentUser };\n  }\n\n  componentDidMount() {\n    window.addEventListener('storage', this.synLogout);\n  }\n\n  //refresh page when logout\n  synLogout = event => {\n    if (event.key === 'logout') {\n      window.location.href = '/login';\n    }\n  };\n\n  render() {\n    const { Component, pageProps, currentUser } = this.props;\n\n    return (\n      <AuthProvider currentUser={currentUser}>\n        <CartProvider>\n          <ModalProvider>\n            <Component {...pageProps} />\n          </ModalProvider>\n        </CartProvider>\n      </AuthProvider>\n    );\n  }\n}\n\nexport default MyApp;\n"]},"metadata":{},"sourceType":"module"}